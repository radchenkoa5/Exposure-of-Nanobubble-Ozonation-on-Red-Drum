---
title: "Linear Model Chlorophyll a analysis"
author: "Anna Radchenko"
date: "March 31, 2020"
output: html_document
---

```{r setup, include=FALSE}
# setup the R enviornment for kniting markdown doc properly
library(knitr)
opts_knit$set(root.dir='../')
```

```{r}
chlwq <- read.csv("./Data/ChlaWQReplicateAcuteData1.csv")
```

```{r}
library(ggplot2)
library(GGally)
library(gridExtra)
library(scatterplot3d)
library(MASS)
library(lubridate)
library(lme4)
class(chlwq$Date)
```

```{r}
chlwq$Time <- factor(chlwq$Time, levels = c("Pre", "Post"))
chlwq$Chl.a1 <- log(chlwq$Chl.a)

```

```{r}
chlwq$Date <- as.Date(chlwq$Date, "%m.%d.%y")
class(chlwq$Date)
chlwq$Date
```


```{r}
ggpairs(chlwq)

```

```{r}
chl <- ggpairs(chlwq, columns = c("Treatment", "Chl.a", "Chl.a1","Time", "Tank", "Temp", "pH"), columnLabels =  c("Treatment", "Chl.a", "Chl.a1","Time", "Tank", "Temp", "pH"))
chl
```




```{r}

## formula method
pairs(Chl.a ~ Treatment + Time + Chl.a1 + pH + Temp, data = chlwq)


## put histograms on the diagonal
panel.hist <- function(x, ...)
{
    usr <- par("usr"); on.exit(par(usr))
    par(usr = c(usr[1:2], 0, 1.5) )
    h <- hist(x, plot = FALSE)
    breaks <- h$breaks; nB <- length(breaks)
    y <- h$counts; y <- y/max(y)
    rect(breaks[-nB], 0, breaks[-1], y, col="cyan", ...)
}

```


```{r}
ggplot(chlwq, aes(Treatment, Chl.a1)) +
  geom_point(aes(col=Date))
  facet_wrap(~Tank)

ggplot(chlwq, aes(Temp, Chl.a1)) +
  geom_point(aes(col=Date)) +
  facet_wrap(~Tank)

ggplot(chlwq, aes(Time, Chl.a1)) +
  geom_point(aes(col=Date)) +
  facet_wrap(~Tank)
```


```{r}
main <- lm(Chl.a1 ~ Treatment + Temp + Time + pH + Salinity + Height + Tank, data = chlwq)
summary(main)
```

```{r}
main2 <- update(main, . ~ . -Salinity - Height)
summary(main2)
```

```{r}
main3 <- update(main2, . ~ . + I(Treatment^2) )
summary(main3)
```

```{r}
anova(main, main2)
```

```{r}
anova(main2, main3)
```
```{r}
AIC(main)
AIC(main2)
AIC(main3)
```



```{r}
lin4 <- lmer(Chl.a1 ~ Treatment + Temp + Time + Treatment*Temp +  pH  + (1|Tank)  , data = chlwq)
car::Anova(lin4, type = 3)
```

```{r}
anova(lin4, main3)
```

```{r}
main4 <- update(main3, .~. + (I(Treatment)^2)*Temp - Treatment)
summary(main4)
```

```{r}
anova(main3, main4)
AIC(main4)
```

```{r}
main5 <- update(main4, .~. + Treatment*Tank)
summary(main5)
```


```{r}
#looking at main5 model with tank & treatment interaction, seems to predict lower treatments better, different slopes for each tank
xrange = range(chlwq$Treatment)
Trange = range(chlwq$Temp)
prange = range(chlwq$pH)
Time = levels(chlwq$Time)


plot(Chl.a1 ~ Treatment, data = chlwq, type = 'n', 
     xlab = 'Volume Ozonated (%)', ylab = 'Log(Chlorophyll a concentration(ug/L)')
points(Chl.a1 ~ Treatment, data = chlwq, subset = Tank == "L1",
       pch = 1, col = 'red')
# add the fitted regression line using two points at either end of the range of x 
lines(xrange, 
      predict.lm(main5, 
              newdata = data.frame(Treatment = xrange, Temp = Trange, pH = prange, Time, Tank = "L1")),
      col = 'red', lty = 1)
points(Chl.a1 ~ Treatment, data = chlwq, subset = Tank == "L2",
       pch = 2, col = 'blue')
lines(xrange, 
      predict.lm(main5, 
              newdata = data.frame(Treatment = xrange, Temp = Trange, pH = prange, Time, Tank = "L2")),
      col = 'blue', lty = 2)
points(Chl.a1 ~ Treatment, data = chlwq, subset = Tank == "L4",
       pch = 3, col = 'green')

lines(xrange, 
      predict.lm(main5, 
              newdata = data.frame(Treatment = xrange, Temp = Trange,  pH = prange, Time, Tank = "L4")),
      col = 'green', lty = 3)
legend('topleft', c('L1', 'L2', 'L4'), col = c('red', 'blue', 'green'), 
       pch = c(1, 2, 3), lty = c(1, 2, 3), bty = 'n')
```

```{r}
#looking at a broader treatment and temperature range, seems like it fits the data beter
xrange = range(0:100)
Trange = range(10:30)
prange = range(7.70:8.1)
Time = levels(chlwq$Time)


plot(Chl.a1 ~ Treatment, data = chlwq, type = 'n', 
     xlab = 'Volume Ozonated (%)', ylab = 'Log(Chlorophyll a concentration(ug/L)')
points(Chl.a1 ~ Treatment, data = chlwq, subset = Tank == "L1",
       pch = 1, col = 'red')
# add the fitted regression line using two points at either end of the range of x 
lines(xrange, 
      predict.lm(main5, 
              newdata = data.frame(Treatment = xrange, Temp = Trange, pH = prange, Time, Tank = "L1")),
      col = 'red', lty = 1)
points(Chl.a1 ~ Treatment, data = chlwq, subset = Tank == "L2",
       pch = 2, col = 'blue')
lines(xrange, 
      predict.lm(main5, 
              newdata = data.frame(Treatment = xrange, Temp = Trange, pH = prange, Time, Tank = "L2")),
      col = 'blue', lty = 2)
points(Chl.a1 ~ Treatment, data = chlwq, subset = Tank == "L4",
       pch = 3, col = 'green')

lines(xrange, 
      predict.lm(main5, 
              newdata = data.frame(Treatment = xrange, Temp = Trange,  pH = prange, Time, Tank = "L4")),
      col = 'green', lty = 3)
legend('topleft', c('L1', 'L2', 'L4'), col = c('red', 'blue', 'green'), 
       pch = c(1, 2, 3), lty = c(1, 2, 3), bty = 'n')
```

```{r}
#looking at main4 model, without treatment & tank interaction, slopes per tank are more similar
xrange = range(chlwq$Treatment)
Trange = range(chlwq$Temp)
prange = range(chlwq$pH)
Time = levels(chlwq$Time)


plot(Chl.a1 ~ Treatment, data = chlwq, type = 'n', 
     xlab = 'Volume Ozonated (%)', ylab = 'Log(Chlorophyll a concentration(ug/L)')
points(Chl.a1 ~ Treatment, data = chlwq, subset = Tank == "L1",
       pch = 1, col = 'red')
# add the fitted regression line using two points at either end of the range of x 
lines(xrange, 
      predict.lm(main4, 
              newdata = data.frame(Treatment = xrange, Temp = Trange, pH = prange, Time, Tank = "L1")),
      col = 'red', lty = 1)
points(Chl.a1 ~ Treatment, data = chlwq, subset = Tank == "L2",
       pch = 2, col = 'blue')
lines(xrange, 
      predict.lm(main4, 
              newdata = data.frame(Treatment = xrange, Temp = Trange, pH = prange, Time, Tank = "L2")),
      col = 'blue', lty = 2)
points(Chl.a1 ~ Treatment, data = chlwq, subset = Tank == "L4",
       pch = 3, col = 'green')

lines(xrange, 
      predict.lm(main4, 
              newdata = data.frame(Treatment = xrange, Temp = Trange,  pH = prange, Time, Tank = "L4")),
      col = 'green', lty = 3)
legend('topleft', c('L1', 'L2', 'L4'), col = c('red', 'blue', 'green'), 
       pch = c(1, 2, 3), lty = c(1, 2, 3), bty = 'n')
```

```{r}
#looking at a broader treatment and temperature range for main 4 model, seems like it fits the data beter

xrange = range(0:100)
Trange = range(10:30)
prange = range(7.70:8.1)
Time = levels(chlwq$Time)


plot(Chl.a1 ~ Treatment, data = chlwq, type = 'n', 
     xlab = 'Volume Ozonated (%)', ylab = 'Log(Chlorophyll a concentration(ug/L)')
points(Chl.a1 ~ Treatment, data = chlwq, subset = Tank == "L1",
       pch = 1, col = 'red')
# add the fitted regression line using two points at either end of the range of x 
lines(xrange, 
      predict.lm(main4, 
              newdata = data.frame(Treatment = xrange, Temp = Trange, pH = prange, Time, Tank = "L1")),
      col = 'red', lty = 1)
points(Chl.a1 ~ Treatment, data = chlwq, subset = Tank == "L2",
       pch = 2, col = 'blue')
lines(xrange, 
      predict.lm(main4, 
              newdata = data.frame(Treatment = xrange, Temp = Trange, pH = prange, Time, Tank = "L2")),
      col = 'blue', lty = 2)
points(Chl.a1 ~ Treatment, data = chlwq, subset = Tank == "L4",
       pch = 3, col = 'green')

lines(xrange, 
      predict.lm(main4, 
              newdata = data.frame(Treatment = xrange, Temp = Trange,  pH = prange, Time, Tank = "L4")),
      col = 'green', lty = 3)
legend('topleft', c('L1', 'L2', 'L4'), col = c('red', 'blue', 'green'), 
       pch = c(1, 2, 3), lty = c(1, 2, 3), bty = 'n')
```
Also looked at modeling without transformed chlorophyll data and the line fits were worse.


```{r}
par(mfrow = c(2,2))
plot(main4)
```

